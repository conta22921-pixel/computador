steps:
  - name: '1. Checkout do Código Fonte'
    uses: actions/checkout@v4
    # Garante que o histórico completo esteja disponível para o Flutter/Flet

  - name: '2. Configurar Python'
    uses: actions/setup-python@v5
    with:
      python-version: '3.11'
      cache: 'pip'

  - name: '3. Instalar Flet CLI'
    run: |
      pip install flet

  - name: '4. Configurar Flutter'
    uses: subosito/flutter-action@v2
    with:
      flutter-version: '3.19.6' # Use a versão estável mais recente
      channel: 'stable'
      cache: true

  - name: '5. Configurar Java para Android Build'
    uses: actions/setup-java@v4
    with:
      distribution: 'temurin'
      # A versão 17 é tipicamente a mínima exigida pelas versões mais recentes do Flutter
      java-version: '17'
      cache: 'gradle'

  - name: '6. Obter Dependências do Projeto (flutter pub get)'
    # Este comando é crucial para que o Flet resolva as dependências do Flutter
    run: flutter pub get

  - name: '7. Fazer o Build do APK Android em Release'
    # Este é o comando Flet para gerar o APK final
    # A linha 51 estaria provavelmente nesta área ou na configuração do Java acima.
    run: flet build apk --release # Linha 51 está por volta desta área no workflow.

  - name: '8. Preparar Artefato: Renomear APK'
    id: prepare_artifact
    run: |
      # Encontra o arquivo APK gerado (o caminho pode variar ligeiramente)
      APK_PATH=$(find ./build -name "*.apk" | head -n 1)
      
      # Define o nome final do arquivo com o nome do commit/SHA
      COMMIT_SHA_SHORT=$(echo $GITHUB_SHA | cut -c1-7)
      NEW_APK_NAME="app-release-${{ github.event.ref_name }}-${COMMIT_SHA_SHORT}.apk"
      
      # Copia e renomeia o APK para o diretório raiz para fácil upload
      cp $APK_PATH $NEW_APK_NAME
      
      # Define a variável de ambiente para o próximo passo
      echo "APK_FILE_NAME=$NEW_APK_NAME" >> $GITHUB_ENV

  - name: '9. Fazer Upload do APK como Artefato'
    uses: actions/upload-artifact@v4
    with:
      name: flet-android-apk-${{ github.event.ref_name }}
      path: ${{ env.APK_FILE_NAME }}
      retention-days: 7